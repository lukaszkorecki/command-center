# -*- mode: sh -*-

## custom paths
export PATH=$HOME/.emacs.d/etc/bin:$PATH

export PATH=$HOME/bin:$PATH
export PATH=./node_modules/.bin:$PATH
export PATH=/opt/homebrew/bin:$PATH
export PATH=/usr/local/bin:$PATH

if [[ -e $(which brew) ]]; then
    brewPrefix=$(brew --prefix)
else
    brewPrefix=""
fi


if [[ "$brewPrefix" != "" ]] ; then
    export PATH=$brewPrefix/bin:$PATH

    pythonPath=$brewPrefix/opt/python/libexec/bin
    if [[ -e $pythonPath ]] ; then
        export PATH="$pythonPath:$PATH"
    fi

    export PATH="$brewPrefix/opt/openjdk/bin:$PATH"
    if [[ -e $brewPrefix/opt/openjdk ]] ; then
        export JAVA_CMD=$brewPrefix/opt/openjdk/bin/java
        export JAVAHOME=$brewPrefix/opt/openjdk/
        export JAVA_HOME=$JAVAHOME

    fi

    export PATH="$brewPrefix/opt/openjdk/bin:$PATH"
    if [[ -e $brewPrefix/opt/openjdk ]] ; then
        export JAVA_CMD=$brewPrefix/opt/openjdk/bin/java
        export JAVAHOME=$brewPrefix/opt/openjdk/
        export JAVA_HOME=$JAVAHOME

    fi
fi

# Emacs stuff
alias emacs='/Applications/Emacs.app/Contents/MacOS/Emacs -nw'
export EDITOR="/Applications/Emacs.app/Contents/MacOS/Emacs -nw"

# integration with Vterm:
if [[ "$INSIDE_EMACS" = 'vterm' ]] \
    && [[ -n ${EMACS_VTERM_PATH} ]] \
    && [[ -f ${EMACS_VTERM_PATH}/etc/emacs-vterm-zsh.sh ]]; then
	source ${EMACS_VTERM_PATH}/etc/emacs-vterm-zsh.sh
fi


## aliases
# go to git repo root
alias gcd='cd $(git root)'
# go to project root, might be repo root but not necessarily
alias pcd='cd $(project-root-path)'

## prompt
# git config
autoload -Uz vcs_info
precmd_vcs_info() { vcs_info }
precmd_functions+=( precmd_vcs_info )
setopt prompt_subst
zstyle ':vcs_info:git:*' formats '%F{240}(%b)'
zstyle ':vcs_info:*' enable git

BR=$'\n'
export PROMPT="# %1~ \$vcs_info_msg_0_ ${BR}# "

## navigation
# make path operations work like bash (e.g. M-backspace deletes path fragments)
autoload -U select-word-style
select-word-style bash

# auto-cd
setopt AUTO_CD

## secrets and stuff
if [[ -e ~/.private/env.sh  ]] ; then
    source ~/.private/env.sh
fi

## load completions

autoload -Uz compinit && compinit
autoload _git
autoload _docker
autoload _docker-compose

# History Configuration
HISTSIZE=5000
SAVEHIST=5000
HISTFILE=~/.zsh_history
HISTDUP=erase
setopt appendhistory
setopt sharehistory
setopt incappendhistory

[[ $(ssh-add -l | grep -v agent) == "" ]] && ssh-add -A

# Load 1password CLI stuff
if [[ -e $(which op) ]] ; then
    # get previous session from the environment
    sessToken=$(security find-generic-password -s cli -a 1pcli -w || true)
    # if not found, get a new one
    if [[ "$sessToken" = "" ]] ; then
        sessToken=$(op signin -f --raw)
    fi

    # and now re-auth
    eval $(op signin -f --session "$sessToken")

    # store token, keychain doesn't suport updates so we delete
    # and store again
    security delete-generic-password -s cli -a 1pcli 2>&1 || true
    security add-generic-password -s cli -a 1pcli -w "$sessToken"
else
    echo "1password-cli not installed"
fi

if [[ -e $brewPrefix/bin/brew ]] ; then
    eval "$($brewPrefix/bin/brew shellenv)"
fi
