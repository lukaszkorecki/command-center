#!/usr/bin/env bash

set -eo pipefail
emacs='/Applications/Emacs.app/Contents/MacOS/Emacs'
depsEdnLocation=$($emacs -batch --eval='(print (locate-dominating-file default-directory "deps.edn"))' | tail -1 | xargs echo)
projectCljLocation=$($emacs -batch --eval='(print (locate-dominating-file default-directory "project.clj"))' | tail -1 | xargs echo)

if [[ "$depsEdnLocation" != "nil" ]] ; then
    echo "Found deps.edn in $depsEdnLocation"
    path=${depsEdnLocation/#\~/$HOME}
    cd $path
    if [[ -e ./script/repl ]] ; then
        echo "using script/repl"
        ./script/repl
    else
        echo "using 'raw' clj"
        TERM=xterm clj -M:dev:nrepl nrepl.cmdline
    fi
fi

if [[ "$projectCljLocation" != "nil" ]] ; then
    echo "Found project.clj in $projectCljLocation"
    path=${projectCljLocation/#\~/$HOME}
    cd $path
    if [[ -e ./script/lein ]] ; then
        echo "Using script/lein"
        ./script/lein $@
    else
        echo "Using global lein"
        lein $@
    fi
fi

echo "deps.edn or project.clj not found!"
