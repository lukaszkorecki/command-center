#!/usr/bin/env bash

set -euo pipefail


if [[ "$(which hub)" == "" ]] ;then
   echo "missing hub binary!"
   exit 1
fi


   help() {
       echo "git-surf v2 - opens various things in GH"
       echo "Flags:"
       grep '##' "$0" | grep -v grep | sed 's/) ##/ - /'g
       exit 0
   }


mode=
# flag vars
commit=
range=
file=
pr=


while getopts "hpf:r:c:" OPTIONS; do
    case "$OPTIONS" in
        h) ## help!
            help
            ;;
        f) ## file to browse
            mode=file
            file="$OPTARG"
            ;;
        r) ## line range in file to browse, needs a file!
            mode=file
            range="$OPTARG"
            ;;

        p) ## are we opening a pr?
            mode=pr
            pr=1
            ;;

        c) ## commit to browse
            mode=commit
            commit="$OPTARG"
            ;;
        *)
            help
            ;;
    esac
done

# returns https://github/<ORG>/<REPO>/tree/<BRANCH>
getRepoURL() {
    hub browse -u
}


gitRoot() {
    git rev-parse --show-toplevel
}

currentBranch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null
}

# https://github.com/<ORG>/<REPO>/commit/c75ec6816c9d276046b4b28bf21df6c9eba8ab08
openCommit() {
    local commit=$1
    if [[ "$commit" == "last" ]] ; then
        commit=$(git log -n 1  --format="%H")
    fi
    url=$(getRepoURL)
    branch=$(currentBranch)

    commitUrl=$(echo $url | sed "s/tree.$branch/commit\/$commit/g")
    echo $commitUrl
}

openPR() {
    hub pr show
}

# https://github.com/<ORG>/<REPO>/blob/<BRANCH>/<PATH>
openFile() {
    local file="$1"
    local range="$2"
    url=$(getRepoURL)
    branch=$(currentBranch)

    if [[ -z "$1" || "$1" == "." ]] ; then
        echo ""
    fi

    fullPath=$(git ls-tree "$branch" --full-name "$file" | awk '{ print $4 }')

    fileUrl="${url/tree/blob}/$fullPath"
    if [[ "$range" == "" ]] ; then
        echo $fileUrl
    else
        rangeMarker="#L${range/,/-L}"
        echo "${fileUrl}${rangeMarker}"
    fi
}

case "$mode" in
    file)
        open $(openFile "$file" "$range")
        ;;
    commit)
        open $(openCommit "$commit")
         ;;
    pr)
        openPR
        ;;
    *)
        echo "unknown mode!"
        exit 1
        ;;
esac
