#!/usr/bin/env bash

set -euo pipefail


if [[ "$(which hub)" == "" ]] ; then
    echo "missing hub binary!"
    exit 1
fi

[[ -e ~/.private/env.sh ]]  && source ~/.private/env.sh

if [[ "$GITHUB_TOKEN" == "" ]] ; then
    echo "missingh GH token"
    exit 2
fi


help() {
    echo "git-surf v2 - opens various things in GH"
    echo "Flags:"
    grep '##' "$0" | grep -v grep | sed 's/) ##/ - /'g
    exit 0
}


mode=
noop=
# flag vars
commit=
range=
file=
pr=


while getopts "hpf:r:c:n" OPTIONS; do
    case "$OPTIONS" in
        h) ## help!
            help
            ;;
        f) ## file to browse
            mode=file
            file="$OPTARG"
            ;;
        r) ## line range in file to browse, needs a file!
            mode=file
            range="$OPTARG"
            ;;

        p) ## are we opening a pr?
            mode=pr
            pr=1
            ;;

        c) ## commit to browse
            mode=commit
            commit="$OPTARG"
            ;;
        n) ## no-op mode aka just print the url
            noop="yes"
            ;;
        *)
            help
            ;;
    esac
done

# returns https://github/<ORG>/<REPO>/tree/<BRANCH>
getRepoURL() {
    hub browse -u
}


gitRoot() {
    git rev-parse --show-toplevel
}

currentBranch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null
}

openOrPrint() {
    local url="$1"
    if [[ "$noop" == "" ]] ; then
        open "$url"
    else
        echo "$url"
    fi
}

# https://github.com/<ORG>/<REPO>/commit/c75ec6816c9d276046b4b28bf21df6c9eba8ab08
commitURL() {
    local commit=$1
    if [[ "$commit" == "last" ]] ; then
        commit=$(git log -n 1  --format="%H")
    fi
    url=$(getRepoURL)


    if [[ $url =~ "/tree/" ]] ; then
       url="$(echo $url | sed 's/tree.*//g')"
    fi
    commitUrl="$url/commit/$commit"
    echo $commitUrl
}

PRURL() {
    url=$(hub pr show -u)
    # above will be empty, if current branch doesn't have a PR yet
    # it's ok, we can navigate to compare page and create one from there
    if [[ "$url" == "" ]] ; then
        url=$(hub compare -u)
    fi
    echo "$url"
}

# https://github.com/<ORG>/<REPO>/blob/<BRANCH>/<PATH>
fileURL() {
    local file="$1"
    local range="$2"
    url=$(getRepoURL)
    branch=$(currentBranch)

    if [[ -z "$1" || "$1" == "." ]] ; then
        echo ""
    fi

    fullPath=$(git ls-tree "$branch" --full-name "$file" | awk '{ print $4 }')

    # we're missing tree/<branch> in the url for some reason
    if [[ ! "$url" =~ "/tree/" ]] ; then
        url="$url/tree/$branch"
    fi

    fileUrl="${url/tree/blob}/$fullPath"

    if [[ "$range" == "" ]] ; then
        echo $fileUrl
    else
        rangeMarker="#L${range/,/-L}"
        echo "${fileUrl}${rangeMarker}"
    fi
}

case "$mode" in
    file)
        openOrPrint $(fileURL "$file" "$range")
        ;;
    commit)
        openOrPrint $(commitURL "$commit")
         ;;
    pr)
        openOrPrint $(PRURL)
        ;;
    *)
        echo "unknown mode!"
        exit 1
        ;;
esac
